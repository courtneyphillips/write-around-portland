<h2>Shopping Cart:</h2>
  <table class="table">
    <thead>
      <th>Publication</th>
      <th>Price</th>
      <th>Quantity</th>
    </thead>
    <tbody>
      <% @order.publications.each do |publication| %>
      <tr>
        <td><%= publication.title %></td>
        <td><%= format_money(publication.price) %></td>
        <td><%= text_field_tag publication.id, quantity_in_cart(publication),
                                  id: publication.id, class: "quantity" %></td>
      </tr>
      <% end %>
    </tbody>
  </table>
  <hr>
  <span class="pull-right">Total:
    <span id="total"><%= format_money(@order.total) %></span>
  </span>


  <%= form_tag orders_path, id: "new_order" do %>
    <script src="https://checkout.stripe.com/checkout.js"></script>
    <%= hidden_field_tag :email %>
    <%= hidden_field_tag :card_token %>

    <%= submit_tag "Pay with Card", id: "custom_button" %>
  <% end %>
  
<script>
  $(".quantity").on("change keyup paste", function() {
    var publication_id = $(this).attr("id");
    var quantity       = $(this).val();
    if (quantity) {
      $.ajax({
        method: "PATCH",
        url: "/update_cart",
        dataType: "json",
        data: { publication_id: publication_id,
                quantity:       quantity }
      }).then(function(response) {
        $("#total").text(response.total);
      });
    }
  });

  var handler = StripeCheckout.configure({
    key: "pk_test_OK48CUYdxgXKXZBFQGXwjTig",
    token: function(token) {
      $("#card_token").val(token.id);
      $("#email").val(token.email);
      $("#new_order").submit();
    }
  });

  $('#custom_button').on('click', function(e) {
    e.preventDefault();
    var total = $("#total").text();
    var amount = parseFloat(total.slice(1));
    // Open Checkout with further options
    handler.open({
      name: 'Total ' + total,
      description: 'Thanks for your purchase!',
      amount: amount * 100
    });
  });
</script>
